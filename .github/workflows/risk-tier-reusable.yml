name: Risk Tier Reusable

on:
  workflow_call:
    inputs:
      repo_rules_path:
        description: Optional path in caller repo to deterministic rules JSON.
        required: false
        type: string
        default: ""
      repo_conditions_path:
        description: Optional path in caller repo to risk-tier conditions markdown.
        required: false
        type: string
        default: "risk-tier-conditions.md"
      claude_model:
        description: Claude model to use for non-deterministic classification.
        required: false
        type: string
        default: "sonnet"
    secrets:
      CLAUDE_ACCESS_TOKEN:
        required: false

permissions:
  contents: read
  pull-requests: write

jobs:
  classify:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout central policy repository
        uses: actions/checkout@v4
        with:
          repository: phishfort/risk-tier-policy-gate
          path: .risk-tier-policy-gate

      - name: Resolve policy file paths
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          CENTRAL_RULES=".risk-tier-policy-gate/config/risk-rules.json"
          CENTRAL_CONDITIONS=".risk-tier-policy-gate/risk-tier-conditions.md"

          RULES_PATH="$CENTRAL_RULES"
          if [[ -n "${{ inputs.repo_rules_path }}" && -f "${{ inputs.repo_rules_path }}" ]]; then
            RULES_PATH="${{ inputs.repo_rules_path }}"
          fi

          CONDITIONS_PATH="$CENTRAL_CONDITIONS"
          if [[ -n "${{ inputs.repo_conditions_path }}" && -f "${{ inputs.repo_conditions_path }}" ]]; then
            CONDITIONS_PATH="${{ inputs.repo_conditions_path }}"
          fi

          echo "rules_path=$RULES_PATH" >> "$GITHUB_OUTPUT"
          echo "conditions_path=$CONDITIONS_PATH" >> "$GITHUB_OUTPUT"

      - name: Collect changed files
        run: |
          git diff --name-only "${{ github.event.pull_request.base.sha }}" "${{ github.sha }}" > changed-files.txt
          echo "Changed files:" && cat changed-files.txt

      - name: Deterministic risk pre-check
        id: rules
        run: |
          node .risk-tier-policy-gate/scripts/risk-rules.mjs changed-files.txt "${{ steps.resolve.outputs.rules_path }}"

      - name: Force high-risk label from deterministic rules
        if: steps.rules.outputs.forced_high == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;
            const botLabelPrefix = 'risktier:';
            const targetLabel = 'risktier:high';

            const { data: labels } = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number });
            for (const l of labels) {
              if (l.name.startsWith(botLabelPrefix) && l.name !== targetLabel) {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name: l.name }).catch(() => {});
              }
            }

            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: [targetLabel] });
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: [
                'Risk tier: **HIGH** (deterministic policy).',
                '',
                'This PR touched one or more high-risk file categories (auth/security/infra/dependencies).',
                'Human review is required.'
              ].join('\n')
            });

      - name: LLM classify + label (non-forced cases)
        if: steps.rules.outputs.forced_high != 'true' && secrets.CLAUDE_ACCESS_TOKEN != ''
        uses: anthropics/claude-code-action@v1
        with:
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_args: "--model ${{ inputs.claude_model }} --max-turns 5 --allowedTools Bash,View,GlobTool,GrepTool,GitHub"
          prompt: |
            Classify this PR and apply exactly one label: `risktier:high` or `risktier:low`.

            Deterministic pre-check result:
            - tier: `${{ steps.rules.outputs.deterministic_tier }}`
            - forced_high: `${{ steps.rules.outputs.forced_high }}`
            - all_low_safe: `${{ steps.rules.outputs.all_low_safe }}`

            Read `risk-result.json` for changed files and pre-check details.
            Read `${{ steps.resolve.outputs.conditions_path }}` for risk-tier policy conditions.

            Rules:
            1) If ANY high-risk category applies, choose `risktier:high`.
            2) Otherwise choose `risktier:low`.
            3) Remove incorrect existing `risktier:` labels before applying.
            4) Post a concise PR comment with:
               - Selected tier
               - 2-5 matched categories/reasons
               - Whether human review is required

      - name: Fallback if LLM unavailable
        if: steps.rules.outputs.forced_high != 'true' && secrets.CLAUDE_ACCESS_TOKEN == ''
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;
            const botLabelPrefix = 'risktier:';
            const targetLabel = 'risktier:high';

            const { data: labels } = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number });
            for (const l of labels) {
              if (l.name.startsWith(botLabelPrefix) && l.name !== targetLabel) {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name: l.name }).catch(() => {});
              }
            }

            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: [targetLabel] });
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: 'Risk tier fallback: **HIGH** (LLM token unavailable). Human review required.'
            });
